<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zombie Rush｜丧尸突袭 - HTML5 FPS</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#1a1f27; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    #ui, #start, #pause { position:fixed; inset:0; pointer-events:none; }
    #hud { position:fixed; left:0; right:0; top:0; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; color:#e6e9ef; font-weight:600; text-shadow:0 1px 2px #000; pointer-events:none; }
    .pill { background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.1); padding:6px 10px; border-radius:10px; margin-right:8px; }
    #healthBar { width:200px; height:12px; background:#2a1d1d; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,.12); }
    #healthFill { height:100%; width:100%; background:linear-gradient(90deg,#ef4444,#b91c1c); }
    #crosshair { position:fixed; left:50%; top:50%; width:12px; height:12px; margin-left:-6px; margin-top:-6px; border:2px solid rgba(255,255,255,.9); border-radius:50%; box-shadow:0 0 10px rgba(255,255,255,.25); pointer-events:none; }
    #hitflash { position:fixed; inset:0; background:rgba(255,60,60,.18); opacity:0; transition:opacity .2s; pointer-events:none; }
    #toast { position:fixed; left:50%; bottom:8%; transform:translateX(-50%); background:rgba(0,0,0,.6); color:#fff; padding:8px 12px; border-radius:10px; font-weight:700; opacity:0; transition:opacity .25s, transform .25s; pointer-events:none; }
    #start { display:flex; align-items:center; justify-content:center; background:radial-gradient(1200px 800px at 50% 30%, rgba(255,90,90,.12), rgba(0,0,0,.75)); color:#eaeaea; }
    .card { pointer-events:auto; background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:22px; width:min(92vw,560px); box-shadow:0 10px 30px rgba(0,0,0,.55); }
    .title { font-size:28px; font-weight:800; letter-spacing:.5px; margin-bottom:10px; }
    .subtitle { opacity:.9; margin-bottom:16px; line-height:1.5; }
    .btn { display:inline-block; padding:10px 16px; border-radius:12px; background:#ef4444; border:none; color:#fff; font-weight:700; cursor:pointer; transition:transform .06s; }
    .btn:active { transform:translateY(1px); }
    .row { display:flex; gap:12px; align-items:center; margin:8px 0; flex-wrap:wrap; }
    .small { font-size:12px; opacity:.9; }
    input[type=range] { width:180px; }

    #pause { display:none; align-items:center; justify-content:center; color:#eaeaea; background:rgba(0,0,0,.55); }
    #pause .card { width:min(92vw,420px); }

    #mobileControls { position:fixed; inset:0; display:none; pointer-events:none; }
    #stickLeft { position:absolute; left:18px; bottom:18px; width:140px; height:140px; border-radius:50%; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); pointer-events:auto; }
    #stickNub { position:absolute; left:50%; top:50%; width:70px; height:70px; margin:-35px 0 0 -35px; border-radius:50%; background:rgba(255,255,255,.35); border:1px solid rgba(255,255,255,.45); }
    .mBtn { position:absolute; right:18px; bottom:18px; width:72px; height:72px; border-radius:16px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); color:#fff; font-weight:800; display:flex; align-items:center; justify-content:center; pointer-events:auto; user-select:none; }
    .mBtn.small { width:58px; height:58px; }
    #btnFire { bottom:18px; right:18px; }
    #btnReload { bottom:98px; right:26px; }
    #btnSwitch { bottom:176px; right:26px; }
    #btnGrenade { bottom:254px; right:26px; }

    canvas { display:block; }
  </style>
</head>
<body>
  <div id="start">
    <div class="card">
      <div class="title">Zombie Rush｜丧尸突袭</div>
      <div class="subtitle">第一人称丧尸射击 · H5 版本（提亮+拾取+三武器）<br>桌面：<b>Play</b> → 点击画面进入鼠标锁定；移动端有虚拟摇杆与按钮。</div>
      <div class="row">
        <button id="btnPlay" class="btn">Play</button>
        <label class="small">亮度 <input id="brightness" type="range" min="0.6" max="2.2" step="0.05" value="1.5"></label>
        <label class="small">灵敏度 <input id="sens" type="range" min="0.2" max="2.0" step="0.05" value="1.0"></label>
      </div>
      <div class="small">WASD 移动 · 鼠标左键射击 · R 换弹 · 1/2/3 切枪 · F 手电筒 · E 拾取 · ESC 暂停</div>
    </div>
  </div>

  <div id="ui">
    <div id="hud">
      <div style="display:flex; align-items:center; gap:10px;">
        <div id="healthBar"><div id="healthFill"></div></div>
        <div class="pill" id="ammo">子弹 12/60</div>
        <div class="pill" id="weapon">手枪</div>
        <div class="pill" id="flashStatus">手电：开</div>
        <div class="pill" id="slots">武器槽 [1:手枪] [2:空] [3:空]</div>
      </div>
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="pill" id="wave">波次 1</div>
        <div class="pill" id="score">得分 0</div>
      </div>
    </div>
    <div id="crosshair"></div>
    <div id="hitflash"></div>
    <div id="toast"></div>
  </div>

  <div id="pause">
    <div class="card">
      <div class="title">暂停</div>
      <div class="row small">按 ESC 返回游戏</div>
      <div class="row small">灵敏度 <input id="sens2" type="range" min="0.2" max="2.0" step="0.05" value="1.0"></div>
      <div class="row"><button id="btnResume" class="btn">继续</button> <button id="btnRestart" class="btn" style="background:#334155">重开</button></div>
    </div>
  </div>

  <div id="mobileControls">
    <div id="stickLeft"><div id="stickNub"></div></div>
    <div id="btnFire" class="mBtn">●</div>
    <div id="btnReload" class="mBtn small">R</div>
    <div id="btnSwitch" class="mBtn small">W</div>
    <div id="btnGrenade" class="mBtn small">G</div>
  </div>

  <script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
  <script>
  console.assert(typeof window.THREE !== 'undefined', 'TEST: THREE should be loaded globally');
  console.assert(!!document.body, 'TEST: DOM should be ready');
  </script>

  <script>
    // ====== 基础状态 ======
    const state = { running:false, paused:false, score:0, wave:1, health:100, time:0, isMobile:/Android|iPhone|iPad|iPod/i.test(navigator.userAgent) };
    let lookSensitivity = 1.0; let yaw=0, pitch=0;

    // ====== 渲染与场景 ======
    const renderer = new THREE.WebGLRenderer({ antialias:true, powerPreference:'high-performance' });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1f27);
    scene.fog = new THREE.Fog(0x1a1f27, 14, 160);

    const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 260);
    camera.position.set(0, 1.65, 5);
    camera.rotation.order = 'YXZ';

    // ====== 光照（更亮的手电） ======
    const amb = new THREE.AmbientLight(0xffffff, 0.42); scene.add(amb);
    const hemi = new THREE.HemisphereLight(0xcfe1ff, 0x1a1d22, 0.95); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xfff2cc, 0.68); dir.position.set(10,14,8); scene.add(dir);

    // 手电筒：更亮、更远、更聚焦
    const headLamp = new THREE.SpotLight(0xffffff, 2.2, 46, Math.PI/7.5, 0.2, 1.0); // intensity↑ distance↑ angle↓
    headLamp.position.set(0,0,0);
    headLamp.target.position.set(0,0,-1);
    let flashlightOn = true;
    camera.add(headLamp); camera.add(headLamp.target); scene.add(camera);

    // 地面 + 建筑
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(260,260), new THREE.MeshStandardMaterial({ color:0x222831, roughness:.9 }));
    ground.rotation.x = -Math.PI/2; scene.add(ground);
    const blockMat = new THREE.MeshStandardMaterial({ color:0x2a323b, roughness:.92 });
    for(let i=0;i<40;i++){
      const w=4+Math.random()*5, h=3+Math.random()*10, d=4+Math.random()*5;
      const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), blockMat);
      const sign=()=>Math.random()<.5?-1:1; m.position.set(sign()*(14+Math.random()*90), h/2, sign()*(14+Math.random()*90));
      scene.add(m);
    }

    // 路灯
    const lamps=[]; for(let i=0;i<16;i++){ const p=new THREE.Vector3((Math.random()-0.5)*180, 4.2, (Math.random()-0.5)*180); const s=new THREE.PointLight(0xffc088, 1.0, 26, 2.0); s.position.copy(p); scene.add(s); lamps.push(s); }

    // 玩家 & 输入
    const player = { pos:new THREE.Vector3(0,1.65,0), speed:4.2, sprint:6.0 };
    const keys = {};

    // 枪（可见模型）
    const gun = new THREE.Group();
    (function buildGun(){
      const body = new THREE.Mesh(new THREE.BoxGeometry(0.38,0.18,0.8), new THREE.MeshStandardMaterial({ color:0x3b3f46, metalness:.2, roughness:.6 })); body.position.set(0, -0.18, -0.6);
      const grip = new THREE.Mesh(new THREE.BoxGeometry(0.12,0.22,0.18), new THREE.MeshStandardMaterial({ color:0x2b2f36, metalness:.15, roughness:.7 })); grip.position.set(-0.08, -0.35, -0.42);
      const barrel = new THREE.Mesh(new THREE.CylinderGeometry(0.04,0.04,0.4, 16), new THREE.MeshStandardMaterial({ color:0x6b717b, metalness:.5, roughness:.4 })); barrel.rotation.x = Math.PI/2; barrel.position.set(0.09, -0.17, -0.98);
      gun.add(body, grip, barrel); gun.position.set(0.32, -0.15, -0.2); camera.add(gun);
    })();
    let recoilT=0;

    // ====== UI ======
    const elStart = document.getElementById('start');
    const elBtnPlay = document.getElementById('btnPlay');
    const elPause = document.getElementById('pause');
    const elBtnResume = document.getElementById('btnResume');
    const elBtnRestart = document.getElementById('btnRestart');
    const elBrightness = document.getElementById('brightness');
    const elSens = document.getElementById('sens');
    const elSens2 = document.getElementById('sens2');
    const elAmmo = document.getElementById('ammo');
    const elWeapon = document.getElementById('weapon');
    const elWave = document.getElementById('wave');
    const elScore = document.getElementById('score');
    const elHealthFill = document.getElementById('healthFill');
    const elHit = document.getElementById('hitflash');
    const elFlashStatus = document.getElementById('flashStatus');
    const elSlots = document.getElementById('slots');
    const elToast = document.getElementById('toast');

    // 移动端控制
    const mc = { move:{x:0,y:0}, firing:false };
    const elMobile = document.getElementById('mobileControls');
    const elStick = document.getElementById('stickLeft');
    const elNub = document.getElementById('stickNub');
    const elBtnFire = document.getElementById('btnFire');
    const elBtnReload = document.getElementById('btnReload');
    const elBtnSwitch = document.getElementById('btnSwitch');
    const elBtnGrenade = document.getElementById('btnGrenade');
    if(state.isMobile){ elMobile.style.display='block'; }

    // ====== 武器系统（3 槽） ======
    const weapons = {
      pistol:{ key:'pistol', name:'手枪', ammoType:'pistol', damage:20, fireRate:5, magSize:12, reload:1.1, spread:0.003, recoil:0.006, range:80 },
      shotgun:{ key:'shotgun', name:'霰弹枪', ammoType:'shotgun', damage:12, pellets:6, fireRate:1.1, magSize:6, reload:1.6, spread:0.02, recoil:0.01, range:35 },
      ar:{ key:'ar', name:'突击步枪', ammoType:'ar', damage:16, fireRate:10, magSize:30, reload:1.8, spread:0.003, recoil:0.003, range:90 }
    };
    // 弹药池
    let ammo = { pistol:{mag:12,reserve:60}, shotgun:{mag:0,reserve:0}, ar:{mag:0,reserve:0} };
    // 拥有的武器槽（最多 3 把）
    let slots = [ 'pistol', null, null ];
    let currentSlot = 0;
    function owned(key){ return slots.includes(key); }
    function updateSlotsUI(){
      const names = slots.map((k,i)=>`[${i+1}:${k? weapons[k].name:'空'}]`).join(' ');
      elSlots.textContent = `武器槽 ${names}`;
      elWeapon.textContent = weapons[ slots[currentSlot] ].name;
      updateAmmoUI();
    }

    function addWeapon(key){
      if(owned(key)) { toast(`已拥有${weapons[key].name}，补给弹药`); addAmmo(key, key==='shotgun'?6: key==='ar'?30:12); return; }
      for(let i=0;i<3;i++) if(!slots[i]){ slots[i]=key; toast(`获得武器：${weapons[key].name}`); currentSlot=i; updateSlotsUI(); return; }
      // 已满：替换当前槽
      toast(`替换为：${weapons[key].name}`); slots[currentSlot]=key; updateSlotsUI();
    }

    function switchTo(slotIndex){ if(slots[slotIndex]){ currentSlot = slotIndex; updateSlotsUI(); } }
    function cycleWeapon(){ for(let i=1;i<=3;i++){ const idx=(currentSlot+i)%3; if(slots[idx]){ currentSlot=idx; updateSlotsUI(); return; } } }

    function addAmmo(key, amount){ const a=ammo[key]; a.reserve += amount; updateAmmoUI(); }

    function currentWeapon(){ return weapons[ slots[currentSlot] ]; }
    function currentAmmo(){ return ammo[ currentWeapon().ammoType ]; }

    function updateAmmoUI(){ const w=currentWeapon(); const a=currentAmmo(); elAmmo.textContent=`子弹 ${a.mag}/${a.reserve}`; elWeapon.textContent=w.name; }
    updateSlotsUI();

    let nextShotTime = 0; // seconds

    // ====== 音频 ======
    const AudioCtx = window.AudioContext || window.webkitAudioContext; let audioCtx=null; const mixer={ master:null };
    function initAudio(){ if(audioCtx) return; audioCtx=new AudioCtx(); mixer.master=audioCtx.createGain(); mixer.master.gain.value=0.45; mixer.master.connect(audioCtx.destination); }
    function beep(f=400,d=0.05,v=0.2){ if(!audioCtx) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.value=f; g.gain.value=v; o.connect(g).connect(mixer.master); o.start(); o.stop(audioCtx.currentTime+d);} 
    function sfxShot(){ beep(200,0.05,0.28);} function sfxReload(){beep(320,0.08,0.2);} function sfxHit(){beep(520,0.03,0.25);} function sfxHurt(){beep(120,0.08,0.25);} function sfxDead(){beep(60,0.25,0.3);} function sfxEmpty(){beep(260,0.05,0.18);} function sfxPickup(){beep(700,0.06,0.25);} function sfxWeapon(){beep(900,0.08,0.3);}

    // ====== 丧尸 ======
    const zombieGeo = new THREE.BoxGeometry(0.9,1.6,0.5);
    const matWalker = new THREE.MeshStandardMaterial({ color:0x7fbf7f, roughness:.85 });
    const matRunner = new THREE.MeshStandardMaterial({ color:0xff7f7f, roughness:.85 });
    const matBrute  = new THREE.MeshStandardMaterial({ color:0x8aa0ff, roughness:.75, metalness:.15 });
    const zombies = new Set();
    const tmpVec = new THREE.Vector3();

    function spawnZombie(type, pos){
      const mesh = new THREE.Mesh(zombieGeo, type==='runner'?matRunner: type==='brute'?matBrute:matWalker);
      mesh.position.copy(pos);
      scene.add(mesh);
      const z = { mesh, type, hp:type==='brute'?160:type==='runner'?60:100, speed:type==='brute'?1.2:type==='runner'?3.2:1.8, dmg:type==='brute'?22:type==='runner'?14:12, nextAttack:0 };
      zombies.add(z); return z;
    }
    function randomSpawnPos(){ const ang=Math.random()*Math.PI*2; const r=32+Math.random()*40; return new THREE.Vector3(Math.cos(ang)*r, 0.8, Math.sin(ang)*r); }

    // ====== 拾取物 ======
    const pickups = new Set();
    const PICKUP_TYPES = {
      ammo_small:{ name:'弹药', color:0xffd166, apply(){ // 给当前武器或随机一把
        const key = slots[currentSlot] || 'pistol'; addAmmo(key, key==='shotgun'?6: key==='ar'?30:12); toast('获得弹药'); sfxPickup(); } },
      medkit:{ name:'医疗包', color:0x66e3a1, apply(){ state.health = Math.min(100, state.health + 30); elHealthFill.style.width=`${state.health}%`; toast('回复生命+30'); sfxPickup(); } },
      weapon_shotgun:{ name:'霰弹枪', color:0x9db2ff, apply(){ addWeapon('shotgun'); addAmmo('shotgun', 6); sfxWeapon(); } },
      weapon_ar:{ name:'突击步枪', color:0xff9d9d, apply(){ addWeapon('ar'); addAmmo('ar', 30); sfxWeapon(); } }
    };

    function spawnPickup(type, pos){
      const def = PICKUP_TYPES[type];
      const geo = new THREE.BoxGeometry(0.5,0.5,0.5);
      const mat = new THREE.MeshStandardMaterial({ color:def.color, emissive:def.color, emissiveIntensity:0.2, roughness:0.6, metalness:0.1 });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.position.copy(pos); mesh.position.y = 0.35;
      scene.add(mesh);
      const p = { mesh, type, t:Math.random()*Math.PI*2 };
      pickups.add(p);
      return p;
    }

    function spawnWorldPickups(){
      // 每波开始随机掉落 2~4 个
      const count = 2 + Math.floor(Math.random()*3);
      const pool = ['ammo_small','medkit','weapon_shotgun','weapon_ar'];
      for(let i=0;i<count;i++){
        const type = pool[Math.floor(Math.random()*pool.length)];
        spawnPickup(type, randomSpawnPos());
      }
    }

    function tryPickupNearby(){
      let nearest=null; let nd=1.5; // 距离阈值
      for(const p of pickups){
        const d = camera.position.distanceTo(p.mesh.position);
        if(d<nd){ nd=d; nearest=p; }
      }
      if(nearest){
        const def = PICKUP_TYPES[nearest.type];
        def.apply();
        scene.remove(nearest.mesh); pickups.delete(nearest);
      }
    }

    // ====== 波次 ======
    function startWave(){
      elWave.textContent = `波次 ${state.wave}`;
      const count = 6 + Math.floor(state.wave*1.8);
      for(let i=0;i<count;i++){
        const t=Math.random(); const type = t>0.85?'brute' : t>0.55?'runner':'walker';
        spawnZombie(type, randomSpawnPos());
      }
      spawnWorldPickups();
    }

    // 僵尸死亡随机掉落
    function dropFromZombie(){
      const r=Math.random();
      if(r<0.18) return 'ammo_small';
      if(r<0.28) return 'medkit';
      if(r<0.32 && !owned('shotgun')) return 'weapon_shotgun';
      if(r<0.36 && !owned('ar')) return 'weapon_ar';
      return null;
    }

    // ====== 开火 ======
    const flashTex = new THREE.CanvasTexture((()=>{ const c=document.createElement('canvas'); c.width=c.height=64; const g=c.getContext('2d'); g.fillStyle='#fff'; g.beginPath(); g.arc(32,32,26,0,Math.PI*2); g.fill(); return c; })());
    const flashMat = new THREE.SpriteMaterial({ map:flashTex, color:0xfff3a0, transparent:true, opacity:0.9 });
    const raycaster = new THREE.Raycaster();

    function shoot(){
      const now=state.time; const w=currentWeapon(); const a=currentAmmo(); if(now<nextShotTime) return; if(a.mag<=0){ sfxEmpty(); return; }
      nextShotTime = now + (1.0/w.fireRate); a.mag--; updateAmmoUI(); sfxShot();
      recoilT = 0.09; gun.position.z -= 0.05; gun.rotation.x -= 0.05;
      const flash = new THREE.Sprite(flashMat); flash.scale.set(0.22,0.22,0.22); flash.position.set(0.09,-0.17,-1.05); camera.add(flash); setTimeout(()=>{ camera.remove(flash); }, 50);

      const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
      const spread = w.spread;
      const pellets = w.pellets || 1;
      for(let i=0;i<pellets;i++){
        const d = dir.clone(); d.x += (Math.random()-0.5)*spread; d.y += (Math.random()-0.5)*spread; d.z += (Math.random()-0.5)*spread; d.normalize();
        raycaster.set(camera.position.clone(), d);
        const targets = Array.from(zombies).map(z=>z.mesh);
        const hits = raycaster.intersectObjects(targets, false);
        if(hits.length>0){
          const hit = hits[0]; const z = Array.from(zombies).find(zz=>zz.mesh===hit.object);
          if(z){ let dmg=w.damage; if(z.type==='brute'&&w.key==='pistol') dmg*=0.6; z.hp-=dmg; sfxHit(); if(z.hp<=0){ zombies.delete(z); scene.remove(z.mesh); addScore(z.type==='brute'?30:z.type==='runner'?20:10);
              const drop = dropFromZombie(); if(drop) spawnPickup(drop, hit.point.clone());
            }
          }
        }
      }
    }

    function reload(){ const w=currentWeapon(); const a=currentAmmo(); const need=w.magSize-a.mag; if(need<=0||a.reserve<=0) return; const take=Math.min(need,a.reserve); a.mag+=take; a.reserve-=take; updateAmmoUI(); sfxReload(); }

    function addScore(v){ state.score+=v; elScore.textContent=`得分 ${state.score}`; }

    // ====== 伤害/死亡 ======
    function damagePlayer(v){ state.health=Math.max(0, state.health-v); elHealthFill.style.width=`${state.health}%`; elHit.style.opacity=0.9; setTimeout(()=>{ elHit.style.opacity=0; }, 60); sfxHurt(); if(state.health<=0) gameOver(); }
    function gameOver(){ state.running=false; state.paused=true; showPause(`你已阵亡\n得分 ${state.score} · 波次 ${state.wave}`); sfxDead(); }

    // ====== 交互辅助 ======
    function toast(msg){ elToast.textContent=msg; elToast.style.opacity=1; elToast.style.transform='translateX(-50%) translateY(-4px)'; clearTimeout(toast._t); toast._t=setTimeout(()=>{ elToast.style.opacity=0; elToast.style.transform='translateX(-50%)'; }, 1000); }

    // ====== 指针锁定 & 视角 ======
    const controls={ get locked(){ return document.pointerLockElement===renderer.domElement; }, lock(){ renderer.domElement.requestPointerLock(); }, unlock(){ if(document.pointerLockElement) document.exitPointerLock(); } };
    function onMouseMove(e){ if(!controls.locked||state.paused||!state.running) return; const s=parseFloat(elSens.value||'1'); yaw -= (e.movementX||0)*0.002*s*lookSensitivity; pitch -= (e.movementY||0)*0.002*s*lookSensitivity; const lim=Math.PI/2-0.01; if(pitch>lim)pitch=lim; if(pitch<-lim)pitch=-lim; camera.rotation.set(pitch,yaw,0,'YXZ'); }
    document.addEventListener('mousemove', onMouseMove);

    // ====== 键盘 ======
    window.addEventListener('keydown', (e)=>{
      keys[e.code]=true;
      if(e.code==='KeyR') reload();
      if(e.code==='Digit1') switchTo(0);
      if(e.code==='Digit2') switchTo(1);
      if(e.code==='Digit3') switchTo(2);
      if(e.code==='KeyF'){ flashlightOn=!flashlightOn; headLamp.visible=flashlightOn; elFlashStatus.textContent = `手电：${flashlightOn?'开':'关'}`; }
      if(e.code==='KeyE'){ tryPickupNearby(); }
      if(e.code==='Escape') togglePause();
    });
    window.addEventListener('keyup', (e)=>{ keys[e.code]=false; });
    renderer.domElement.addEventListener('mousedown', ()=>{ if(!state.running) return; if(!state.paused) shoot(); });

    // ====== 暂停 ======
    function togglePause(){ if(!state.running) return; state.paused=!state.paused; if(state.paused){ showPause(); controls.unlock(); } else { hidePause(); controls.lock(); } }
    function showPause(msg){ elPause.style.display='flex'; elPause.querySelector('.subtitle')?.remove(); if(msg){ const p=document.createElement('div'); p.className='subtitle'; p.style.whiteSpace='pre-wrap'; p.textContent=msg; elPause.querySelector('.card').insertBefore(p, elPause.querySelector('.row')); } }
    function hidePause(){ elPause.style.display='none'; }

    // ====== 启动 ======
    elBtnPlay.addEventListener('click', ()=>{ initAudio(); startGame(); });
    elBtnResume.addEventListener('click', ()=> togglePause());
    elBtnRestart.addEventListener('click', ()=> location.reload());
    elSens.addEventListener('input', ()=>{ lookSensitivity=parseFloat(elSens.value); elSens2.value=elSens.value; });
    elSens2.addEventListener('input', ()=>{ lookSensitivity=parseFloat(elSens2.value); elSens.value=elSens2.value; });
    elBrightness.addEventListener('input', ()=>{ const k=parseFloat(elBrightness.value); amb.intensity=0.3*k; hemi.intensity=0.7*k; dir.intensity=0.55*k; headLamp.intensity=1.6*k; headLamp.distance=40*k; scene.fog.near=14/k; scene.fog.far=160*k; });

    // ====== 移动端 ======
    function setupStick(){ let touching=false; let center={x:0,y:0}; elStick.addEventListener('touchstart',(e)=>{ touching=true; const r=elStick.getBoundingClientRect(); center={x:r.left+r.width/2,y:r.top+r.height/2}; elNub.style.transform='translate(0,0)'; mc.move={x:0,y:0}; }); elStick.addEventListener('touchmove',(e)=>{ if(!touching)return; const t=e.changedTouches[0]; let dx=t.clientX-center.x, dy=t.clientY-center.y; const max=60; const len=Math.hypot(dx,dy); if(len>max){ dx=dx/len*max; dy=dy/len*max; } elNub.style.transform=`translate(${dx}px,${dy}px)`; mc.move={x:dx/max,y:dy/max}; }); const end=()=>{ touching=false; mc.move={x:0,y:0}; elNub.style.transform='translate(0,0)'; }; elStick.addEventListener('touchend',end); elStick.addEventListener('touchcancel',end); elBtnFire.addEventListener('touchstart',()=>{ mc.firing=true; }); elBtnFire.addEventListener('touchend',()=>{ mc.firing=false; }); elBtnReload.addEventListener('touchstart',()=> reload()); elBtnSwitch.addEventListener('touchstart',()=> cycleWeapon()); elBtnGrenade.addEventListener('touchstart',()=>{/* todo */}); }
    if(state.isMobile) setupStick();

    function startGame(){ state.running=true; state.paused=false; state.score=0; state.wave=1; state.health=100; document.getElementById('healthFill').style.width='100%'; elScore.textContent='得分 0'; elWave.textContent='波次 1'; elFlashStatus.textContent='手电：开'; headLamp.visible=true; flashlightOn=true; elStart.style.display='none'; hidePause(); controls.lock(); document.addEventListener('click', ()=>{ if(!audioCtx) initAudio(); }, { once:true }); startWave(); animate(0); }

    function getMoveVec(){
      let x=0,z=0;
      if(state.isMobile){ x=mc.move.x; z=-mc.move.y; } // 上推前进
      else { if(keys['KeyW']) z+=1; if(keys['KeyS']) z-=1; if(keys['KeyA']) x+=1; if(keys['KeyD']) x-=1; }
      const v=new THREE.Vector3(x,0,z); if(v.lengthSq()>0) v.normalize(); return v;
    }

    // ====== 主循环 ======
    let last=performance.now();
    function animate(t){
      const dt=Math.min(0.033,(t-last)/1000); last=t; state.time+=dt;
      if(state.running&&!state.paused){
        for(const L of lamps){ L.intensity=0.7+Math.random()*0.4; }
        const mv=getMoveVec(); const up=new THREE.Vector3(0,1,0); const forward=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion); forward.y=0; forward.normalize(); const right=new THREE.Vector3().crossVectors(up, forward).normalize();
        const speed=(keys['ShiftLeft']||state.isMobile&&Math.abs(mc.move.x)+Math.abs(mc.move.y)>1.2)?player.sprint:player.speed;
        player.pos.addScaledVector(forward, mv.z*speed*dt);
        player.pos.addScaledVector(right,   mv.x*speed*dt);
        player.pos.x=THREE.MathUtils.clamp(player.pos.x,-120,120); player.pos.z=THREE.MathUtils.clamp(player.pos.z,-120,120); camera.position.copy(player.pos);
        if(state.isMobile&&mc.firing){ shoot(); }
        if(recoilT>0){ recoilT-=dt; gun.position.z=Math.min(gun.position.z+dt*0.6, 0.32-0.15); gun.rotation.x=Math.min(gun.rotation.x+dt*0.6, 0); }
        // 物品漂浮动画
        for(const p of pickups){ p.t+=dt; p.mesh.position.y = 0.35 + Math.sin(p.t*2)*0.06; p.mesh.rotation.y += dt*1.6; }
        // 丧尸行为
        for(const z of Array.from(zombies)){
          tmpVec.copy(player.pos).sub(z.mesh.position); tmpVec.y=0; const dist=tmpVec.length(); if(dist>0.0001){ tmpVec.normalize(); z.mesh.position.addScaledVector(tmpVec, z.speed*dt); } z.mesh.position.y=0.8+Math.sin(state.time*6)*0.02; if(dist<1.2 && state.time>z.nextAttack){ z.nextAttack=state.time+0.8+Math.random()*0.6; damagePlayer(z.dmg); }
        }
        // 自动拾取（移动端友好）
        if(state.isMobile){ tryPickupNearby(); }
        if(zombies.size===0){ state.wave++; addScore(25); startWave(); }
        elWave.textContent=`波次 ${state.wave}`;
      }
      renderer.render(scene,camera);
      requestAnimationFrame(animate);
    }

    // ====== Resize ======
    window.addEventListener('resize', ()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); });
  </script>
</body>
</html>
